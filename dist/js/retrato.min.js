/*! retrato 2014-09-09 */
function Loading(a,b){function c(){d=b.view,watch(a,"loading",function(){d.toggle(a.loading)}),d.hide()}var d=null;c()}function AlbumNavigator(a,b){function c(){h=b.view,g=b.template,i=b.listClass?h.find("."+b.listClass):h,j=b.listClass?b.listClass:!0,watch(a,"albuns",function(){e()})}function d(b){var c=Settings.URL_PREFIX+a.path+"/"+b;return c=StringUtil.sanitizeUrl(c)}function e(){if(!a.albuns||0===a.albuns.length)return void h.removeClass("visible");h.addClass("visible"),content="";for(var b=0;b<a.albuns.length;b++){var c=a.albuns[b];content+=Mustache.render(g,{url:d(c),name:StringUtil.humanizeName(c)})}i.html(content),f()}function f(){h.find("a").click(function(b){b.preventDefault(),$("html,body").animate({scrollTop:0},500),a.loadAlbum($(this).attr("href"))})}var g=null,h=null,i=null,j=!0;c()}function AlbumBreadcrumb(a,b){function c(){f=b.view,g=b.listClass?f.find("."+b.listClass):f,h=b.templateHome,i=b.template,watch(a,"path",function(){e.updatePath()}),watch(a,"selectedPictureIndex",function(){e.updatePath()})}function d(){g.find("a").click(function(){return a.loadAlbum($(this).attr("href")),!1})}var e=this,f=null,g=null,h=null,i=null;this.updatePath=function(){var b=a.path.split("/");if(""===b[b.length-1]&&b.pop(),null!==a.selectedPictureIndex){var c=a.pictures[a.selectedPictureIndex];b.push(c.filename)}for(var e="/",f=Mustache.render(h,{url:StringUtil.sanitizeUrl(Settings.URL_PREFIX+"/")}),j=1;j<b.length;j++)e+=b[j]+"/",params={},j<b.length-1&&(params.url=StringUtil.sanitizeUrl(Settings.URL_PREFIX+e)),params.name=StringUtil.humanizeName(b[j]),f+=Mustache.render(i,params);g.html(f),d()},c()}function AlbumMenu(a,b){function c(){i=b.view,j=b.detailsButton,k=b.fullscreenButton,watch(a,"selectedPictureIndex",function(){d(),e(),g()}),j.click(function(a){a.preventDefault(),f()}),k.click(function(a){a.preventDefault(),h()}),Fullscreen.onchange(function(){k.toggleClass("selected",Fullscreen.isActive())}),e(),g()}function d(){null!==a.selectedPictureIndex&&(i.addClass("headroom--pinned").addClass("headroom--top"),i.removeClass("headroom--not-top").removeClass("headroom--unpinned"))}function e(){null===a.selectedPictureIndex?(a.detailsOn=!1,j.hide()):j.show()}function f(){a.detailsOn=!a.detailsOn,j.toggleClass("selected",a.detailsOn)}function g(){null===a.selectedPictureIndex?(a.detailsOn=!1,k.hide()):k.show()}function h(){Fullscreen.isActive()?Fullscreen.close():Fullscreen.open(document.getElementById("content"))}var i=null,j=null,k=null;c()}function AlbumDeepLinking(a){function b(){watch(a,"path",function(){d()}),$(window).bind("popstate",function(){e()}),e()}function c(){var a=location.pathname;return a=a.replace(Settings.URL_PREFIX,""),a||(a="/"),a}function d(){var b=location.pathname,c=Settings.URL_PREFIX+a.path;b!=c&&(c=StringUtil.sanitizeUrl(c),history.pushState(null,null,c))}function e(){var b=c();b!=a.path&&a.loadAlbum(b)}b()}function AlbumPhotos(a,b){function c(){f=b.view,g=b.listClass?f.find("."+b.listClass):f,h=b.template,b.heightProportion&&(j=b.heightProportion),watch(a,"pictures",function(a,b,c){var d=Array.isArray(c);e.displayPictures(d)}),$(window).resize(function(){e.resizePictures()})}function d(){function b(){c>=a.pictures.length||(g.find("img:eq("+c+")").data("index",c),d.src==a.pictures[c].thumb?(c++,b()):d.src=a.pictures[c].thumb)}var c=0,d=new Image;d.onload=function(){g.find("img:eq("+c+")").attr("src",this.src).show(),c++,b()},b()}var e=this,f=null,g=null,h=null,i=0,j=.45,k=2;this.displayPictures=function(c){if(c!==!1){if(g.empty(),!a.pictures||0===a.pictures.length)return void f.hide();f.show();var e=new Resize(a.pictures,j);i=f.width(),console.log("currentWidth: "+i);var l=e.doResize(i,$(window).height());content="";for(var m=0;m<l.length;m++){var n=l[m],o={width:n.newWidth-k,height:n.newHeight-k};b.lazyLoad||(o.src=n.thumb),content+=Mustache.render(h,o)}g.html(content),g.find("img").click(function(){a.selectedPictureIndex=$(this).data("index")}),b.lazyLoad&&d()}},this.resizePictures=function(){var b=f.width();if(b!=i){i=f.width();var c=new Resize(a.pictures,j),d=c.doResize(i,$(window).height());g.children().each(function(a){var b=d[a],c=b.newWidth-k,e=b.newHeight-k;$(this).css("width",c).css("height",e),$(this).find("img").attr("width",c).attr("height",e)})}},c()}function AlbumPageTitle(a,b){function c(){b&&b.template&&(d=b.template),e=b&&b.templateEmpty?b.templateEmpty:d,watch(a,"path",function(){self.updateTitle()}),watch(a,"selectedPictureIndex",function(){self.updateTitle()})}var d="Album {{title}}",e="",f=" | ";this.updateTitle=function(){var b=a.path;b=b.replace(/^\//,""),b=b.replace(/\/$/,""),b=b.replace(/[\/]+/g,f);var c="";c=b?Mustache.render(d,{title:b}):Mustache.render(e),document.title=c},c()}function Highlight(a,b){function c(){v=b.view,w=b.listClass?v.find("."+b.listClass):v,x=b.template,y=b.detailsView,watch(a,"selectedPictureIndex",function(){d(),t()}),watch(a,"detailsOn",function(){a.detailsOn?r():s()}),v.click(function(){u.close()}),$(window).resize(function(){u.updateDisplay()}),$("body").keyup(function(a){37==a.keyCode?u.displayPrevPicture():39==a.keyCode?u.displayNextPicture():27==a.keyCode&&u.close()})}function d(){return C?void(null===a.selectedPictureIndex&&u.close()):(u.handleScroll(),void u.displayPicture())}function e(a){"el"!=a.target.id&&(a.preventDefault(),a.stopPropagation())}function f(){var a=$(Mustache.render(x,{}));return a}function g(){z=f(),z.addClass("current-frame"),w.append(z)}function h(){A&&A.remove(),A=f(),A.addClass("prev-frame"),w.append(A)}function i(){B&&B.remove(),B=f(),B.addClass("next-frame"),w.append(B)}function j(b){var c=v,d=c.width(),e=c.height();a.detailsOn&&(d-=y.width());var f=d-2*D,g=Math.round(f/b.ratio),h=0,i=Math.round((e-g)/2);return E>i&&(g=e-(E+2*D),f=Math.round(g*b.ratio),i=0,h=Math.round((c.width()-f)/2)),h=(d-f)/2,i=(e-E-g)/2+E,{newWidth:f,newHeight:g,x:h,y:i}}function k(a){var b=j(a);return b.x=-1*b.newWidth-50,b}function l(a){var b=j(a);return b.x=v.width()+50,b}function m(a,b){var c=a.find(".high-res");c.hide(),image=new Image,image.onload=function(){c.attr("src",this.src),c.fadeIn()},image.src=b.highlight}function n(a,b){var c=a.find(".low-res");c.attr("src",b.thumb)}function o(a,b){var c=a.find(".large-photo");c.css("left",b.x+"px").css("top",b.y+"px"),c.css("width",b.newWidth+"px").css("height",b.newHeight+"px")}function p(a,b){z.find(".large-photo").animate({left:b.x,top:b.y,width:b.newWidth,height:b.newHeight},500)}function q(a){u.blurTimeout=setTimeout(function(){var b=a.find(".box-blur").hide();b.fadeIn(2e3),boxBlurImage(a.find(".low-res").get(0),b.get(0),20,!1,2),b.show()},500)}function r(){y.animate({right:0},500);var b=a.pictures[a.selectedPictureIndex],c=j(b);p(z,c)}function s(){if(y.animate({right:-y.width()},500),z){var b=a.pictures[a.selectedPictureIndex],c=j(b);p(z,c)}}function t(){var b=a.pictures[a.selectedPictureIndex];b&&(y.find(".file-name").html(b.filename),y.find(".file-date").html(b.date),y.find(".file-width").html(b.width),y.find(".file-height").html(b.height))}var u=this,v=null,w=null,x=null,y=null,z=null,A=null,B=null,C=!1,D=15,E=45;this.handleScroll=function(){$("body").on("mousewheel",e)},this.unhandleScroll=function(){$("body").off("mousewheel",e)},this.hasPicturesToDisplay=function(){return null!==a.selectedPictureIndex&&a.selectedPictureIndex>=0&&a.pictures&&a.pictures.length>=0},this.close=function(){C=!1,u.unhandleScroll(),v.fadeOut("slow"),a.selectedPictureIndex=null,Fullscreen.close()},this.displayPicture=function(){return u.hasPicturesToDisplay()?(C=!0,w.empty(),g(),h(),i(),void u.updateDisplay()):void u.close()},this.displayPrevPicture=function(){if(u.hasPicturesToDisplay()&&(w.find(".large-photo").stop(),0!==a.selectedPictureIndex)){var b=a.pictures[a.selectedPictureIndex];a.selectedPictureIndex--;var c=A;c.removeClass("prev-frame").addClass("current-frame");var d=a.pictures[a.selectedPictureIndex],e=j(d);c.find(".box-blur").hide(),c.find(".large-photo").animate({left:e.x},500,"swing",function(){q(c,d),m(c,d)});var f=z;f.removeClass("current-frame").addClass("next-frame");var g=l(b);if(f.find(".large-photo").animate({left:g.x},500,"swing"),B&&B.remove(),B=z,z=A,A=null,a.selectedPictureIndex>0){h();var i=a.pictures[a.selectedPictureIndex-1],p=k(i);o(A,p),n(A,i)}}},this.displayNextPicture=function(){if(u.hasPicturesToDisplay()&&(w.find(".large-photo").stop(),!(a.selectedPictureIndex>=a.pictures.length-1))){var b=a.pictures[a.selectedPictureIndex];a.selectedPictureIndex++;var c=B;c.removeClass("next-frame").addClass("current-frame");var d=a.pictures[a.selectedPictureIndex],e=j(d);c.find(".box-blur").hide(),c.find(".large-photo").animate({left:e.x},500,"swing",function(){q(c,d),m(c,d)});var f=z;f.removeClass("current-frame").addClass("prev-frame");var g=k(b);if(f.find(".large-photo").animate({left:g.x},500,"swing"),A&&A.remove(),A=z,z=B,B=null,a.selectedPictureIndex<a.pictures.length-1){i();var h=a.pictures[a.selectedPictureIndex+1],p=l(h);o(B,p),n(B,h)}}},this.updateDisplay=function(){if(u.hasPicturesToDisplay()&&C){v.fadeIn("slow");var b,c;z&&(b=a.pictures[a.selectedPictureIndex].dimension=j(b),o(z,c),n(z,b),m(z,b),z.find(".box-blur").is(":visible")||q(z,b)),A&&a.selectedPictureIndex>0&&(b=a.pictures[a.selectedPictureIndex-1],c=k(b),o(A,c),n(A,b)),B&&a.selectedPictureIndex<a.pictures.length-1&&(b=a.pictures[a.selectedPictureIndex+1],c=l(b),o(B,c),n(B,b))}},c()}function AlbumModel(a){function b(a){for(var b in a)e.hasOwnProperty(b)&&(e[b]=a[b]);e.loading=!1,e.selectedPictureIndex=null}function c(){e.loading=!1,alert("Album does not exist")}var d=a,e=this;return this.path=null,this.albuns=null,this.pictures=null,this.visibility=null,this.loading=!1,this.selectedPictureIndex=null,this.highlightOn=!1,this.detailsOn=!1,this.loadAlbum=function(a){e.loading=!0,d.get(a,b,c)},this}function AlbumAjaxDelegate(){this.get=function(a,b,c){var d=a.replace(Settings.URL_PREFIX,"");d=Settings.URL_DATA_PREFIX+d,d=StringUtil.sanitizeUrl(d),$.get(d,function(a){b(a)}).fail(function(a){c(a)})}}function AlbumHtmlDelegate(a){this.get=function(b,c,d){if(0===a.length)return d();var e={path:b,pictures:[]};a.each(function(a,b){$el=$(b);var c=parseFloat($el.attr("width"))/parseFloat($el.attr("height"));c=Math.round(1e3*c)/1e3;var d={width:$el.attr("width"),height:$el.attr("height"),thumb:$el.attr("src"),url:$el.data("photo"),highlight:$el.data("photo"),ratio:c};e.pictures.push(d)}),c(e)}}function Resize(a,b){this.pictures=a,this.HEIGHT_PROPORTION=.45,b&&(this.HEIGHT_PROPORTION=b)}function linearPartition(a,b){if(0>=b)return[];var c=a.length-1,d=[];if(b>c){for(var e in a)d.push([a[e]]);return d}var f=linearPartitionTable(a,b);b-=2;for(var g=[];b>=0;){var h=a.slice(f[c-1][b]+1,c+1);g=[h].concat(g),c=f[c-1][b],b-=1}return g=[a.slice(0,c+1)].concat(g)}function linearPartitionTable(a,b){var c,d,e,f=a.length,g=[],h=[];for(c=0;b>c;c++)h.push(0);for(c=0;f>c;c++)g.push(h.slice());var i=[];for(h=[],c=0;b-1>c;c++)h.push(0);for(c=0;f-1>c;c++)i.push(h.slice());for(c=0;f>c;c++){var j=a[c];c>0&&(j+=g[c-1][0]),g[c][0]=j}for(d=0;b>d;d++)g[0][d]=a[0];for(c=1;f>c;c++)for(d=1;b>d;d++){var k=null,l=null;for(e=0;c>e;e++){var m=Math.max(g[e][d-1],g[c][0]-g[e][0]);(null===k||k>m)&&(k=m,l=e)}g[c][d]=k,i[c-1][d-1]=l}return i}var Settings={URL_PREFIX:"/",URL_DATA_PREFIX:"/api/"},StringUtil={sanitizeUrl:function(a){return a=a.replace(/([^:])[\/]+/g,"$1/")},humanizeName:function(a){return a=a.replace(/_/g," "),a=a.replace(/\.jpe?g/i,"")}},Fullscreen={open:function(a){a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen&&a.msRequestFullscreen()},close:function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},onchange:function(a){document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),document.addEventListener("mozfullscreenchange",a),document.addEventListener("MSFullscreenChange",a)},isActive:function(){return null!==document.fullScreenElement||null!==document.webkitCurrentFullScreenElement||null!==document.mozFullScreenElement||null!==document.msFullscreenElement}};Resize.prototype.doResize=function(a,b){var c=parseInt(b*this.HEIGHT_PROPORTION),d=this.sumWidth(c),e=Math.ceil(d/a);return this.resizeUsingLinearPartitions(e,a)},Resize.prototype.sumWidth=function(a){var b,c=0;for(var d in this.pictures)b=this.pictures[d],c+=b.ratio*a;return c},Resize.prototype.resizeToSameHeight=function(a){var b;for(var c in this.pictures)b=this.pictures[c],b.newWidth=parseInt(a*b.ratio),b.newHeight=a;return this.pictures},Resize.prototype.resizeUsingLinearPartitions=function(a,b){var c,d,e,f=[];for(d in this.pictures)c=this.pictures[d],f.push(parseInt(100*c.ratio));var g=linearPartition(f,a),h=0,i=[];for(d in g){partition=g[d];var j=[];for(e in partition)j.push(this.pictures[h]),h++;var k=0;for(e in j)c=j[e],k+=c.ratio;for(e in j){c=j[e];var l={};l.newWidth=parseInt(b/k*c.ratio),l.newHeight=parseInt(b/k),i.push(l)}}return i};