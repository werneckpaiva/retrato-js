/*! retrato 2014-09-16 */
function AlbumMenu(a,b){function c(){i=b.view,j=b.detailsButton,k=b.fullscreenButton,watch(a,"selectedPictureIndex",function(){d(),e(),g()}),j.click(function(a){a.preventDefault(),f()}),k.click(function(a){a.preventDefault(),h()}),Fullscreen.onchange(function(){k.toggleClass("selected",Fullscreen.isActive())}),e(),g()}function d(){null!==a.selectedPictureIndex&&(i.addClass("headroom--pinned").addClass("headroom--top"),i.removeClass("headroom--not-top").removeClass("headroom--unpinned"))}function e(){null===a.selectedPictureIndex?(a.detailsOn=!1,j.hide()):j.show()}function f(){a.detailsOn=!a.detailsOn,j.toggleClass("selected",a.detailsOn)}function g(){null===a.selectedPictureIndex?(a.detailsOn=!1,k.hide()):k.show()}function h(){Fullscreen.isActive()?Fullscreen.close():Fullscreen.open(document.getElementById("content"))}var i=null,j=null,k=null;c()}function AlbumPhotos(a,b){function c(){d(),watch(a,"pictures",function(a,b,c){var d=Array.isArray(c);f.displayPictures(d)}),$(window).resize(function(){f.resizePictures()})}function d(){g=b.view,i=b.template,h=b.listClass?g.find("."+b.listClass):g,k=b.heightProportion?b.heightProportion:.45,l=b.lazyLoad?b.lazyLoad:!1,m=b.margin?b.margin:0}function e(){function b(){c>=a.pictures.length||(d.src==a.pictures[c].thumb?(c++,b()):d.src=a.pictures[c].thumb)}var c=0,d=new Image;d.onload=function(){h.find("img:eq("+c+")").attr("src",this.src).show(),c++,b()},b()}var f=this,g=null,h=null,i=null,j=0,k=null,l=!1,m=0;this.displayPictures=function(b){if(b!==!1){if(h.empty(),!a.pictures||0===a.pictures.length)return void g.hide();g.show();var c=new Resize(a.pictures,k);j=g.width();for(var d=c.doResize(j,$(window).height()),f="",n=0;n<d.length;n++){var o=d[n],p={width:o.newWidth-m,height:o.newHeight-m};l||(p.src=a.pictures[n].thumb),f+=Mustache.render(i,p)}h.html(f),h.find("img").each(function(a,b){$(b).data("index",a)}).click(function(){a.selectedPictureIndex=$(this).data("index")}),l&&e()}},this.resizePictures=function(){var b=g.width();if(b!=j){j=g.width();var c=new Resize(a.pictures,k),d=c.doResize(j,$(window).height());h.children().each(function(a){var b=d[a],c=b.newWidth-m,e=b.newHeight-m;$(this).css("width",c).css("height",e),$(this).find("img").attr("width",c).attr("height",e)})}},c()}function boxBlurImage(a,b,c,d,e){var f=b.width,g=b.height,h=b.getContext("2d");if(h.clearRect(0,0,b.width,b.height),h.drawImage(a,0,0,b.width,b.height),!(isNaN(c)||1>c)){d?boxBlurCanvasRGBA(b,0,0,f,g,c,e):boxBlurCanvasRGB(b,0,0,f,g,c,e);var i=Math.round(b.width/2),j=Math.round(b.height/2),k=h.createRadialGradient(i,j,0,i,j,i+0);k.addColorStop(0,"rgba(0,0,0,0)"),k.addColorStop(1,"rgba(0,0,0,0.6)"),h.fillStyle=k,h.fillRect(0,0,b.width,b.height)}}function boxBlurCanvasRGBA(a,b,c,d,e,f,g){if(!(isNaN(f)||1>f)){f|=0,isNaN(g)&&(g=1),g|=0,g>3&&(g=3),1>g&&(g=1);var h,i=a.getContext("2d");try{try{h=i.getImageData(b,c,d,e)}catch(j){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=i.getImageData(b,c,d,e)}catch(j){throw alert("Cannot access local image"),new Error("unable to access local image data: "+j)}}}catch(j){throw alert("Cannot access image"),new Error("unable to access image data: "+j)}for(var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=h.data,z=d-1,A=e-1,B=f+1,C=mul_table[f],D=shg_table[f],E=[],F=[],G=[],H=[],I=[],J=[];g-->0;){for(w=v=0,p=0;e>p;p++){for(k=y[w]*B,l=y[w+1]*B,m=y[w+2]*B,n=y[w+3]*B,q=1;f>=q;q++)r=w+((q>z?z:q)<<2),k+=y[r++],l+=y[r++],m+=y[r++],n+=y[r];for(o=0;d>o;o++)E[v]=k,F[v]=l,G[v]=m,H[v]=n,0==p&&(I[o]=((r=o+B)<z?r:z)<<2,J[o]=(r=o-f)>0?r<<2:0),s=w+I[o],t=w+J[o],k+=y[s++]-y[t++],l+=y[s++]-y[t++],m+=y[s++]-y[t++],n+=y[s]-y[t],v++;w+=d<<2}for(o=0;d>o;o++){for(u=o,k=E[u]*B,l=F[u]*B,m=G[u]*B,n=H[u]*B,q=1;f>=q;q++)u+=q>A?0:d,k+=E[u],l+=F[u],m+=G[u],n+=H[u];for(v=o<<2,p=0;e>p;p++)y[v+3]=x=n*C>>>D,x>0?(x=255/x,y[v]=(k*C>>>D)*x,y[v+1]=(l*C>>>D)*x,y[v+2]=(m*C>>>D)*x):y[v]=y[v+1]=y[v+2]=0,0==o&&(I[p]=((r=p+B)<A?r:A)*d,J[p]=(r=p-f)>0?r*d:0),s=o+I[p],t=o+J[p],k+=E[s]-E[t],l+=F[s]-F[t],m+=G[s]-G[t],n+=H[s]-H[t],v+=d<<2}}i.putImageData(h,b,c)}}function boxBlurCanvasRGB(a,b,c,d,e,f,g){if(!(isNaN(f)||1>f)){f|=0,isNaN(g)&&(g=1),g|=0,g>3&&(g=3),1>g&&(g=1);var h,i=a.getContext("2d");try{try{h=i.getImageData(b,c,d,e)}catch(j){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=i.getImageData(b,c,d,e)}catch(j){throw alert("Cannot access local image"),new Error("unable to access local image data: "+j)}}}catch(j){throw alert("Cannot access image"),new Error("unable to access image data: "+j)}for(var k,l,m,n,o,p,q,r,s,t,u,v,w=h.data,x=d-1,y=e-1,z=f+1,A=[],B=[],C=[],D=mul_table[f],E=shg_table[f],F=[],G=[];g-->0;){for(v=u=0,o=0;e>o;o++){for(k=w[v]*z,l=w[v+1]*z,m=w[v+2]*z,p=1;f>=p;p++)q=v+((p>x?x:p)<<2),k+=w[q++],l+=w[q++],m+=w[q++];for(n=0;d>n;n++)A[u]=k,B[u]=l,C[u]=m,0==o&&(F[n]=((q=n+z)<x?q:x)<<2,G[n]=(q=n-f)>0?q<<2:0),r=v+F[n],s=v+G[n],k+=w[r++]-w[s++],l+=w[r++]-w[s++],m+=w[r++]-w[s++],u++;v+=d<<2}for(n=0;d>n;n++){for(t=n,k=A[t]*z,l=B[t]*z,m=C[t]*z,p=1;f>=p;p++)t+=p>y?0:d,k+=A[t],l+=B[t],m+=C[t];for(u=n<<2,o=0;e>o;o++)w[u]=k*D>>>E,w[u+1]=l*D>>>E,w[u+2]=m*D>>>E,0==n&&(F[o]=((q=o+z)<y?q:y)*d,G[o]=(q=o-f)>0?q*d:0),r=n+F[o],s=n+G[o],k+=A[r]-A[s],l+=B[r]-B[s],m+=C[r]-C[s],u+=d<<2}}i.putImageData(h,b,c)}}function Highlight(a,b){function c(){v=b.view,w=b.listClass?v.find("."+b.listClass):v,x=b.template,y=b.detailsView?b.detailsView:[],F=b.boxBlurClass?"."+b.boxBlurClass:".box-blur",watch(a,"selectedPictureIndex",function(){d(),t()}),watch(a,"detailsOn",function(){a.detailsOn?r():s()}),v.click(function(){u.close()}),$(window).resize(function(){u.updateDisplay()}),$("body").keyup(function(a){37==a.keyCode?u.displayPrevPicture():39==a.keyCode?u.displayNextPicture():27==a.keyCode&&u.close()})}function d(){return C?void(null===a.selectedPictureIndex&&u.close()):(u.handleScroll(),void u.displayPicture())}function e(a){"el"!=a.target.id&&(a.preventDefault(),a.stopPropagation())}function f(){var a=$(Mustache.render(x,{}));return a}function g(){z=f(),z.addClass("current-frame"),w.append(z)}function h(){A&&A.remove(),A=f(),A.addClass("prev-frame"),w.append(A)}function i(){B&&B.remove(),B=f(),B.addClass("next-frame"),w.append(B)}function j(b){var c=v,d=c.width(),e=c.height();a.detailsOn&&(d-=y.width());var f=d-2*D,g=Math.round(f/b.ratio),h=0,i=Math.round((e-g)/2);return E>i&&(g=e-(E+2*D),f=Math.round(g*b.ratio),i=0,h=Math.round((c.width()-f)/2)),h=(d-f)/2,i=(e-E-g)/2+E,{newWidth:f,newHeight:g,x:h,y:i}}function k(a){var b=j(a);return b.x=-1*b.newWidth-50,b}function l(a){var b=j(a);return b.x=v.width()+50,b}function m(a,b){var c=a.find(".high-res");c.hide(),image=new Image,image.onload=function(){c.attr("src",this.src),c.fadeIn()},image.src=b.highlight}function n(a,b){var c=a.find(".low-res");c.attr("src",b.thumb)}function o(a,b){var c=a.find(".large-photo");c.css("left",b.x+"px").css("top",b.y+"px"),c.css("width",b.newWidth+"px").css("height",b.newHeight+"px")}function p(a,b){z.find(".large-photo").animate({left:b.x,top:b.y,width:b.newWidth,height:b.newHeight},500)}function q(a){u.blurTimeout=setTimeout(function(){var b=a.find(F).hide();b.fadeIn(2e3),boxBlurImage(a.find(".low-res").get(0),b.get(0),20,!1,2),b.show()},500)}function r(){y.animate({right:0},500);var b=a.pictures[a.selectedPictureIndex],c=j(b);p(z,c)}function s(){if(y.animate({right:-y.width()},500),z){var b=a.pictures[a.selectedPictureIndex],c=j(b);p(z,c)}}function t(){var b=a.pictures[a.selectedPictureIndex];b&&(y.find(".file-name").html(b.filename),y.find(".file-date").html(b.date),y.find(".file-width").html(b.width),y.find(".file-height").html(b.height))}var u=this,v=null,w=null,x=null,y=null,z=null,A=null,B=null,C=!1,D=15,E=0,F=null;this.handleScroll=function(){$("body").on("mousewheel",e)},this.unhandleScroll=function(){$("body").off("mousewheel",e)},this.hasPicturesToDisplay=function(){return null!==a.selectedPictureIndex&&a.selectedPictureIndex>=0&&a.pictures&&a.pictures.length>=0},this.close=function(){C=!1,u.unhandleScroll(),v.fadeOut("slow"),a.selectedPictureIndex=null,Fullscreen.close()},this.displayPicture=function(){return u.hasPicturesToDisplay()?(C=!0,w.empty(),g(),h(),i(),void u.updateDisplay()):void u.close()},this.displayPrevPicture=function(){if(u.hasPicturesToDisplay()&&(w.find(".large-photo").stop(),0!==a.selectedPictureIndex)){var b=a.pictures[a.selectedPictureIndex];a.selectedPictureIndex--;var c=A;c.removeClass("prev-frame").addClass("current-frame");var d=a.pictures[a.selectedPictureIndex],e=j(d);c.find(F).hide(),c.find(".large-photo").animate({left:e.x},500,"swing",function(){q(c,d),m(c,d)});var f=z;f.removeClass("current-frame").addClass("next-frame");var g=l(b);if(f.find(".large-photo").animate({left:g.x},500,"swing"),B&&B.remove(),B=z,z=A,A=null,a.selectedPictureIndex>0){h();var i=a.pictures[a.selectedPictureIndex-1],p=k(i);o(A,p),n(A,i)}}},this.displayNextPicture=function(){if(u.hasPicturesToDisplay()&&(w.find(".large-photo").stop(),!(a.selectedPictureIndex>=a.pictures.length-1))){var b=a.pictures[a.selectedPictureIndex];a.selectedPictureIndex++;var c=B;c.removeClass("next-frame").addClass("current-frame");var d=a.pictures[a.selectedPictureIndex],e=j(d);c.find(F).hide(),c.find(".large-photo").animate({left:e.x},500,"swing",function(){q(c,d),m(c,d)});var f=z;f.removeClass("current-frame").addClass("prev-frame");var g=k(b);if(f.find(".large-photo").animate({left:g.x},500,"swing"),A&&A.remove(),A=z,z=B,B=null,a.selectedPictureIndex<a.pictures.length-1){i();var h=a.pictures[a.selectedPictureIndex+1],p=l(h);o(B,p),n(B,h)}}},this.updateDisplay=function(){if(u.hasPicturesToDisplay()&&C){v.fadeIn("slow");var b,c;z&&(b=a.pictures[a.selectedPictureIndex],c=j(b),o(z,c),n(z,b),m(z,b),z.find(F).is(":visible")||q(z,b)),A&&a.selectedPictureIndex>0&&(b=a.pictures[a.selectedPictureIndex-1],c=k(b),o(A,c),n(A,b)),B&&a.selectedPictureIndex<a.pictures.length-1&&(b=a.pictures[a.selectedPictureIndex+1],c=l(b),o(B,c),n(B,b))}},c()}function AlbumModel(a){function b(a){for(var b in a)e.hasOwnProperty(b)&&(e[b]=a[b]);e.loading=!1,e.selectedPictureIndex=null}function c(){e.loading=!1,alert("Album does not exist")}var d=a,e=this;return this.path=null,this.albuns=null,this.pictures=null,this.visibility=null,this.loading=!1,this.selectedPictureIndex=null,this.highlightOn=!1,this.detailsOn=!1,this.loadAlbum=function(a){e.loading=!0,d.get(a,b,c)},this}function AlbumAjaxDelegate(){this.get=function(a,b,c){var d=a.replace(Settings.URL_PREFIX,"");d=Settings.URL_DATA_PREFIX+d,d=StringUtil.sanitizeUrl(d),$.get(d,function(a){b(a)}).fail(function(a){c(a)})}}function AlbumHtmlDelegate(a){this.get=function(b,c,d){if(0===a.length)return d();var e={path:b,pictures:[]};a.each(function(a,b){$el=$(b);var c=parseFloat($el.attr("width"))/parseFloat($el.attr("height"));c=Math.round(1e3*c)/1e3;var d={width:$el.attr("width"),height:$el.attr("height"),thumb:$el.attr("src"),url:$el.data("photo"),highlight:$el.data("photo"),ratio:c};e.pictures.push(d)}),c(e)}}function Resize(a,b){this.pictures=a,this.HEIGHT_PROPORTION=.45,b&&(this.HEIGHT_PROPORTION=b)}function linearPartition(a,b){if(0>=b)return[];var c=a.length-1,d=[];if(b>c){for(var e in a)d.push([a[e]]);return d}var f=linearPartitionTable(a,b);b-=2;for(var g=[];b>=0;){var h=a.slice(f[c-1][b]+1,c+1);g=[h].concat(g),c=f[c-1][b],b-=1}return g=[a.slice(0,c+1)].concat(g)}function linearPartitionTable(a,b){var c,d,e,f=a.length,g=[],h=[];for(c=0;b>c;c++)h.push(0);for(c=0;f>c;c++)g.push(h.slice());var i=[];for(h=[],c=0;b-1>c;c++)h.push(0);for(c=0;f-1>c;c++)i.push(h.slice());for(c=0;f>c;c++){var j=a[c];c>0&&(j+=g[c-1][0]),g[c][0]=j}for(d=0;b>d;d++)g[0][d]=a[0];for(c=1;f>c;c++)for(d=1;b>d;d++){var k=null,l=null;for(e=0;c>e;e++){var m=Math.max(g[e][d-1],g[c][0]-g[e][0]);(null===k||k>m)&&(k=m,l=e)}g[c][d]=k,i[c-1][d-1]=l}return i}var Settings={URL_PREFIX:"/",URL_DATA_PREFIX:"/api/"},StringUtil={sanitizeUrl:function(a){return a=a.replace(/([^:])[\/]+/g,"$1/")},humanizeName:function(a){return a=a.replace(/_/g," "),a=a.replace(/\.jpe?g/i,"")}},Fullscreen={open:function(a){a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen&&a.msRequestFullscreen()},close:function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},onchange:function(a){document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),document.addEventListener("mozfullscreenchange",a),document.addEventListener("MSFullscreenChange",a)},isActive:function(){return null!==document.fullScreenElement||null!==document.webkitCurrentFullScreenElement||null!==document.mozFullScreenElement||null!==document.msFullscreenElement}},mul_table=[1,57,41,21,203,34,97,73,227,91,149,62,105,45,39,137,241,107,3,173,39,71,65,238,219,101,187,87,81,151,141,133,249,117,221,209,197,187,177,169,5,153,73,139,133,127,243,233,223,107,103,99,191,23,177,171,165,159,77,149,9,139,135,131,253,245,119,231,224,109,211,103,25,195,189,23,45,175,171,83,81,79,155,151,147,9,141,137,67,131,129,251,123,30,235,115,113,221,217,53,13,51,50,49,193,189,185,91,179,175,43,169,83,163,5,79,155,19,75,147,145,143,35,69,17,67,33,65,255,251,247,243,239,59,29,229,113,111,219,27,213,105,207,51,201,199,49,193,191,47,93,183,181,179,11,87,43,85,167,165,163,161,159,157,155,77,19,75,37,73,145,143,141,35,138,137,135,67,33,131,129,255,63,250,247,61,121,239,237,117,29,229,227,225,111,55,109,216,213,211,209,207,205,203,201,199,197,195,193,48,190,47,93,185,183,181,179,178,176,175,173,171,85,21,167,165,41,163,161,5,79,157,78,154,153,19,75,149,74,147,73,144,143,71,141,140,139,137,17,135,134,133,66,131,65,129,1],shg_table=[0,9,10,10,14,12,14,14,16,15,16,15,16,15,15,17,18,17,12,18,16,17,17,19,19,18,19,18,18,19,19,19,20,19,20,20,20,20,20,20,15,20,19,20,20,20,21,21,21,20,20,20,21,18,21,21,21,21,20,21,17,21,21,21,22,22,21,22,22,21,22,21,19,22,22,19,20,22,22,21,21,21,22,22,22,18,22,22,21,22,22,23,22,20,23,22,22,23,23,21,19,21,21,21,23,23,23,22,23,23,21,23,22,23,18,22,23,20,22,23,23,23,21,22,20,22,21,22,24,24,24,24,24,22,21,24,23,23,24,21,24,23,24,22,24,24,22,24,24,22,23,24,24,24,20,23,22,23,24,24,24,24,24,24,24,23,21,23,22,23,24,24,24,22,24,24,24,23,22,24,24,25,23,25,25,23,24,25,25,24,22,25,25,25,24,23,24,25,25,25,25,25,25,25,25,25,25,25,25,23,25,23,24,25,25,25,25,25,25,25,25,25,24,22,25,25,23,25,25,20,24,25,24,25,25,22,24,25,24,25,24,25,25,24,25,25,25,25,22,25,25,25,24,25,24,25,18];Resize.prototype.doResize=function(a,b){a=Math.floor(a);var c=parseInt(b*this.HEIGHT_PROPORTION),d=this.sumWidth(c),e=Math.ceil(d/a);return this.resizeUsingLinearPartitions(e,a)},Resize.prototype.sumWidth=function(a){var b,c=0;for(var d in this.pictures)b=this.pictures[d],c+=b.ratio*a;return c},Resize.prototype.resizeToSameHeight=function(a){var b;for(var c in this.pictures)b=this.pictures[c],b.newWidth=parseInt(a*b.ratio),b.newHeight=a;return this.pictures},Resize.prototype.resizeUsingLinearPartitions=function(a,b){var c,d,e,f=[];for(d in this.pictures)c=this.pictures[d],f.push(parseInt(100*c.ratio));var g=linearPartition(f,a),h=0,i=[];for(d in g){partition=g[d];var j=[];for(e in partition)j.push(this.pictures[h]),h++;var k=0;for(e in j)c=j[e],k+=c.ratio;var l=b/k,m=0;for(e in j){c=j[e];var n={};n.newWidth=parseInt(l*c.ratio),m+=n.newWidth,n.newHeight=parseInt(l),i.push(n)}}return i};