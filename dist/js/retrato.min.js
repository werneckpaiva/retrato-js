/*! retrato 2014-09-20 */
function AlbumMenu(a,b){function c(){i=b.view,j=b.detailsButton,k=b.fullscreenButton,watch(a,"selectedPictureIndex",function(){d(),e(),g()}),j.click(function(a){a.preventDefault(),f()}),k.click(function(a){a.preventDefault(),h()}),Fullscreen.onchange(function(){k.toggleClass("selected",Fullscreen.isActive())}),e(),g()}function d(){null!==a.selectedPictureIndex&&(i.addClass("headroom--pinned").addClass("headroom--top"),i.removeClass("headroom--not-top").removeClass("headroom--unpinned"))}function e(){null===a.selectedPictureIndex?(a.detailsOn=!1,j.hide()):j.show()}function f(){a.detailsOn=!a.detailsOn,j.toggleClass("selected",a.detailsOn)}function g(){null===a.selectedPictureIndex?(a.detailsOn=!1,k.hide()):k.show()}function h(){Fullscreen.isActive()?Fullscreen.close():Fullscreen.open(document.getElementById("content"))}var i=null,j=null,k=null;c()}function AlbumPhotos(a,b){function c(){d(),watch(a,"pictures",function(a,b,c){var d=Array.isArray(c);f.displayPictures(d)}),$(window).resize(function(){f.resizePictures()})}function d(){g=b.view,i=b.template,h=b.listClass?g.find("."+b.listClass):g,k=b.heightProportion?b.heightProportion:.45,l=b.lazyLoad?b.lazyLoad:!1,m=b.margin?b.margin:0}function e(){function b(){c>=a.pictures.length||(d.src==a.pictures[c].thumb?(c++,b()):d.src=a.pictures[c].thumb)}var c=0,d=new Image;d.onload=function(){h.find("img:eq("+c+")").attr("src",this.src).show(),c++,b()},b()}var f=this,g=null,h=null,i=null,j=0,k=null,l=!1,m=0;this.displayPictures=function(b){if(b!==!1){if(h.empty(),!a.pictures||0===a.pictures.length)return void g.hide();g.show();var c=new Resize(a.pictures,k);j=g.width();for(var d=c.doResize(j,$(window).height()),f="",n=0;n<d.length;n++){var o=d[n],p={width:o.newWidth-m,height:o.newHeight-m};l||(p.src=a.pictures[n].thumb),f+=Mustache.render(i,p)}h.html(f),h.find("img").each(function(a,b){$(b).data("index",a)}).click(function(){a.selectedPictureIndex=$(this).data("index")}),l&&e()}},this.resizePictures=function(){var b=g.width();if(b!=j){j=g.width();var c=new Resize(a.pictures,k),d=c.doResize(j,$(window).height());h.children().each(function(a){var b=d[a],c=b.newWidth-m,e=b.newHeight-m;$(this).css("width",c).css("height",e),$(this).find("img").attr("width",c).attr("height",e)})}},c()}function boxBlurImage(a,b,c,d,e){var f=b.width,g=b.height,h=b.getContext("2d");if(h.clearRect(0,0,b.width,b.height),h.drawImage(a,0,0,b.width,b.height),!(isNaN(c)||1>c)){d?boxBlurCanvasRGBA(b,0,0,f,g,c,e):boxBlurCanvasRGB(b,0,0,f,g,c,e);var i=Math.round(b.width/2),j=Math.round(b.height/2),k=h.createRadialGradient(i,j,0,i,j,i+0);k.addColorStop(0,"rgba(0,0,0,0)"),k.addColorStop(1,"rgba(0,0,0,0.6)"),h.fillStyle=k,h.fillRect(0,0,b.width,b.height)}}function boxBlurCanvasRGBA(a,b,c,d,e,f,g){if(!(isNaN(f)||1>f)){f|=0,isNaN(g)&&(g=1),g|=0,g>3&&(g=3),1>g&&(g=1);var h,i=a.getContext("2d");try{try{h=i.getImageData(b,c,d,e)}catch(j){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=i.getImageData(b,c,d,e)}catch(k){throw new Error("unable to access local image data: "+k)}}}catch(j){throw new Error("unable to access image data: "+j)}for(var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=h.data,A=d-1,B=e-1,C=f+1,D=mul_table[f],E=shg_table[f],F=[],G=[],H=[],I=[],J=[],K=[];g-->0;){for(x=w=0,q=0;e>q;q++){for(l=z[x]*C,m=z[x+1]*C,n=z[x+2]*C,o=z[x+3]*C,r=1;f>=r;r++)s=x+((r>A?A:r)<<2),l+=z[s++],m+=z[s++],n+=z[s++],o+=z[s];for(p=0;d>p;p++)F[w]=l,G[w]=m,H[w]=n,I[w]=o,0===q&&(J[p]=((s=p+C)<A?s:A)<<2,K[p]=(s=p-f)>0?s<<2:0),t=x+J[p],u=x+K[p],l+=z[t++]-z[u++],m+=z[t++]-z[u++],n+=z[t++]-z[u++],o+=z[t]-z[u],w++;x+=d<<2}for(p=0;d>p;p++){for(v=p,l=F[v]*C,m=G[v]*C,n=H[v]*C,o=I[v]*C,r=1;f>=r;r++)v+=r>B?0:d,l+=F[v],m+=G[v],n+=H[v],o+=I[v];for(w=p<<2,q=0;e>q;q++)z[w+3]=y=o*D>>>E,y>0?(y=255/y,z[w]=(l*D>>>E)*y,z[w+1]=(m*D>>>E)*y,z[w+2]=(n*D>>>E)*y):z[w]=z[w+1]=z[w+2]=0,0===p&&(J[q]=((s=q+C)<B?s:B)*d,K[q]=(s=q-f)>0?s*d:0),t=p+J[q],u=p+K[q],l+=F[t]-F[u],m+=G[t]-G[u],n+=H[t]-H[u],o+=I[t]-I[u],w+=d<<2}}i.putImageData(h,b,c)}}function boxBlurCanvasRGB(a,b,c,d,e,f,g){if(!(isNaN(f)||1>f)){f|=0,isNaN(g)&&(g=1),g|=0,g>3&&(g=3),1>g&&(g=1);var h,i=a.getContext("2d");try{try{h=i.getImageData(b,c,d,e)}catch(j){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=i.getImageData(b,c,d,e)}catch(k){throw new Error("unable to access local image data: "+k)}}}catch(k){throw new Error("unable to access image data: "+k)}for(var l,m,n,o,p,q,r,s,t,u,v,w,x=h.data,y=d-1,z=e-1,A=f+1,B=[],C=[],D=[],E=mul_table[f],F=shg_table[f],G=[],H=[];g-->0;){for(w=v=0,p=0;e>p;p++){for(l=x[w]*A,m=x[w+1]*A,n=x[w+2]*A,q=1;f>=q;q++)r=w+((q>y?y:q)<<2),l+=x[r++],m+=x[r++],n+=x[r++];for(o=0;d>o;o++)B[v]=l,C[v]=m,D[v]=n,0===p&&(G[o]=((r=o+A)<y?r:y)<<2,H[o]=(r=o-f)>0?r<<2:0),s=w+G[o],t=w+H[o],l+=x[s++]-x[t++],m+=x[s++]-x[t++],n+=x[s++]-x[t++],v++;w+=d<<2}for(o=0;d>o;o++){for(u=o,l=B[u]*A,m=C[u]*A,n=D[u]*A,q=1;f>=q;q++)u+=q>z?0:d,l+=B[u],m+=C[u],n+=D[u];for(v=o<<2,p=0;e>p;p++)x[v]=l*E>>>F,x[v+1]=m*E>>>F,x[v+2]=n*E>>>F,0===o&&(G[p]=((r=p+A)<z?r:z)*d,H[p]=(r=p-f)>0?r*d:0),s=o+G[p],t=o+H[p],l+=B[s]-B[t],m+=C[s]-C[t],n+=D[s]-D[t],v+=d<<2}}i.putImageData(h,b,c)}}function Highlight(a,b){function c(){y=b.view,z=b.listClass?y.find("."+b.listClass):d(),A=b.template,B=b.detailsView?b.detailsView:[],e(),watch(a,"selectedPictureIndex",function(){f(),w()}),watch(a,"detailsOn",function(){a.detailsOn?u():v()}),y.click(function(){x.close()}),$(window).resize(function(){x.updateDisplay()}),$("body").keyup(function(a){37==a.keyCode?x.displayPrevPicture():39==a.keyCode?x.displayNextPicture():27==a.keyCode&&x.close()})}function d(){var a=$("<div class='frame-container'></div>");return y.append(a),a}function e(){return I=$('<div class="blur-container"></div>'),y.append(I),I}function f(){return F?void(null===a.selectedPictureIndex&&x.close()):(x.handleScroll(),x.displayPicture(),void I.empty())}function g(a){"el"!=a.target.id&&(a.preventDefault(),a.stopPropagation())}function h(){var a=$(Mustache.render(A,{}));return a}function i(){var a=$('<canvas class="blur"/>');return I.append(a),a}function j(){C=h(),C.addClass("current-frame"),z.append(C)}function k(){D&&D.remove(),D=h(),D.addClass("prev-frame"),z.append(D)}function l(){E&&E.remove(),E=h(),E.addClass("next-frame"),z.append(E)}function m(b){var c=y,d=c.width(),e=c.height();a.detailsOn&&(d-=B.width());var f=d-2*G,g=Math.round(f/b.ratio),h=0,i=Math.round((e-g)/2);return H>i&&(g=e-(H+2*G),f=Math.round(g*b.ratio),i=0,h=Math.round((c.width()-f)/2)),h=(d-f)/2,i=(e-H-g)/2+H,{newWidth:f,newHeight:g,x:h,y:i}}function n(a){var b=m(a);return b.x=-1*b.newWidth-50,b}function o(a){var b=m(a);return b.x=y.width()+50,b}function p(a,b){var c=a.find(".high-res");c.hide(),image=new Image,image.onload=function(){c.attr("src",this.src),c.fadeIn()},image.src=b.highlight}function q(a,b){var c=a.find(".low-res");c.attr("src",b.thumb)}function r(a,b){var c=a.find(".large-photo");c.css("left",b.x+"px").css("top",b.y+"px"),c.css("width",b.newWidth+"px").css("height",b.newHeight+"px")}function s(a,b){C.find(".large-photo").animate({left:b.x,top:b.y,width:b.newWidth,height:b.newHeight},500)}function t(a){clearTimeout(x.blurTimeout),x.blurTimeout=setTimeout(function(){I.children().fadeOut(2e3,function(){$(this).remove()});var b=i();boxBlurImage(a.find(".low-res").get(0),b.get(0),20,!1,2),b.fadeIn(2e3)},500)}function u(){B.animate({right:0},500);var b=a.pictures[a.selectedPictureIndex],c=m(b);s(C,c)}function v(){if(B.animate({right:-B.width()},500),C){var b=a.pictures[a.selectedPictureIndex],c=m(b);s(C,c)}}function w(){var b=a.pictures[a.selectedPictureIndex];b&&(B.find(".file-name").html(b.filename),B.find(".file-date").html(b.date),B.find(".file-width").html(b.width),B.find(".file-height").html(b.height))}var x=this,y=null,z=null,A=null,B=null,C=null,D=null,E=null,F=!1,G=15,H=0,I=null;this.handleScroll=function(){$("body").on("mousewheel",g)},this.unhandleScroll=function(){$("body").off("mousewheel",g)},this.hasPicturesToDisplay=function(){return null!==a.selectedPictureIndex&&a.selectedPictureIndex>=0&&a.pictures&&a.pictures.length>=0},this.close=function(){F=!1,x.unhandleScroll(),y.fadeOut("slow"),a.selectedPictureIndex=null,Fullscreen.close()},this.displayPicture=function(){return x.hasPicturesToDisplay()?(F=!0,z.empty(),j(),k(),l(),void x.updateDisplay()):void x.close()},this.displayPrevPicture=function(){if(x.hasPicturesToDisplay()&&(z.find(".large-photo").stop(),0!==a.selectedPictureIndex)){var b=a.pictures[a.selectedPictureIndex];a.selectedPictureIndex--;var c=D;c.removeClass("prev-frame").addClass("current-frame");var d=a.pictures[a.selectedPictureIndex],e=m(d);c.find(".large-photo").animate({left:e.x},500,"swing",function(){t(c,d),p(c,d)});var f=C;f.removeClass("current-frame").addClass("next-frame");var g=o(b);if(f.find(".large-photo").animate({left:g.x},500,"swing"),E&&E.remove(),E=C,C=D,D=null,a.selectedPictureIndex>0){k();var h=a.pictures[a.selectedPictureIndex-1],i=n(h);r(D,i),q(D,h)}}},this.displayNextPicture=function(){if(x.hasPicturesToDisplay()&&(z.find(".large-photo").stop(),!(a.selectedPictureIndex>=a.pictures.length-1))){var b=a.pictures[a.selectedPictureIndex];a.selectedPictureIndex++;var c=E;c.removeClass("next-frame").addClass("current-frame");var d=a.pictures[a.selectedPictureIndex],e=m(d);c.find(".large-photo").animate({left:e.x},500,"swing",function(){t(c,d),p(c,d)});var f=C;f.removeClass("current-frame").addClass("prev-frame");var g=n(b);if(f.find(".large-photo").animate({left:g.x},500,"swing"),D&&D.remove(),D=C,C=E,E=null,a.selectedPictureIndex<a.pictures.length-1){l();var h=a.pictures[a.selectedPictureIndex+1],i=o(h);r(E,i),q(E,h)}}},this.updateDisplay=function(){if(x.hasPicturesToDisplay()&&F){y.fadeIn("slow");var b,c;C&&(b=a.pictures[a.selectedPictureIndex],c=m(b),r(C,c),q(C,b),p(C,b),t(C,b)),D&&a.selectedPictureIndex>0&&(b=a.pictures[a.selectedPictureIndex-1],c=n(b),r(D,c),q(D,b)),E&&a.selectedPictureIndex<a.pictures.length-1&&(b=a.pictures[a.selectedPictureIndex+1],c=o(b),r(E,c),q(E,b))}},c()}function AlbumModel(a){function b(a){for(var b in a)e.hasOwnProperty(b)&&(e[b]=a[b]);e.loading=!1,e.selectedPictureIndex=null}function c(){e.loading=!1,alert("Album does not exist")}var d=a,e=this;return this.path=null,this.albuns=null,this.pictures=null,this.visibility=null,this.loading=!1,this.selectedPictureIndex=null,this.highlightOn=!1,this.detailsOn=!1,this.loadAlbum=function(a){e.loading=!0,d.get(a,b,c)},this}function AlbumAjaxDelegate(){this.get=function(a,b,c){var d=a.replace(Settings.URL_PREFIX,"");d=Settings.URL_DATA_PREFIX+d,d=StringUtil.sanitizeUrl(d),$.get(d,function(a){b(a)}).fail(function(a){c(a)})}}function AlbumHtmlDelegate(a){this.get=function(b,c,d){if(0===a.length)return d();var e={path:b,pictures:[]};a.each(function(a,b){$el=$(b);var c=parseFloat($el.attr("width"))/parseFloat($el.attr("height"));c=Math.round(1e3*c)/1e3;var d={width:$el.attr("width"),height:$el.attr("height"),thumb:$el.attr("src"),url:$el.data("photo"),highlight:$el.data("photo"),ratio:c};e.pictures.push(d)}),c(e)}}function Resize(a,b){this.pictures=a,this.HEIGHT_PROPORTION=.45,b&&(this.HEIGHT_PROPORTION=b)}function linearPartition(a,b){if(0>=b)return[];var c=a.length-1,d=[];if(b>c){for(var e in a)d.push([a[e]]);return d}var f=linearPartitionTable(a,b);b-=2;for(var g=[];b>=0;){var h=a.slice(f[c-1][b]+1,c+1);g=[h].concat(g),c=f[c-1][b],b-=1}return g=[a.slice(0,c+1)].concat(g)}function linearPartitionTable(a,b){var c,d,e,f=a.length,g=[],h=[];for(c=0;b>c;c++)h.push(0);for(c=0;f>c;c++)g.push(h.slice());var i=[];for(h=[],c=0;b-1>c;c++)h.push(0);for(c=0;f-1>c;c++)i.push(h.slice());for(c=0;f>c;c++){var j=a[c];c>0&&(j+=g[c-1][0]),g[c][0]=j}for(d=0;b>d;d++)g[0][d]=a[0];for(c=1;f>c;c++)for(d=1;b>d;d++){var k=null,l=null;for(e=0;c>e;e++){var m=Math.max(g[e][d-1],g[c][0]-g[e][0]);(null===k||k>m)&&(k=m,l=e)}g[c][d]=k,i[c-1][d-1]=l}return i}var Settings={URL_PREFIX:"/",URL_DATA_PREFIX:"/api/"},StringUtil={sanitizeUrl:function(a){return a=a.replace(/([^:])[\/]+/g,"$1/")},humanizeName:function(a){return a=a.replace(/_/g," "),a=a.replace(/\.jpe?g/i,"")}},Fullscreen={open:function(a){a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen&&a.msRequestFullscreen()},close:function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},onchange:function(a){document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),document.addEventListener("mozfullscreenchange",a),document.addEventListener("MSFullscreenChange",a)},isActive:function(){return null!==document.fullScreenElement||null!==document.webkitCurrentFullScreenElement||null!==document.mozFullScreenElement||null!==document.msFullscreenElement}},mul_table=[1,57,41,21,203,34,97,73,227,91,149,62,105,45,39,137,241,107,3,173,39,71,65,238,219,101,187,87,81,151,141,133,249,117,221,209,197,187,177,169,5,153,73,139,133,127,243,233,223,107,103,99,191,23,177,171,165,159,77,149,9,139,135,131,253,245,119,231,224,109,211,103,25,195,189,23,45,175,171,83,81,79,155,151,147,9,141,137,67,131,129,251,123,30,235,115,113,221,217,53,13,51,50,49,193,189,185,91,179,175,43,169,83,163,5,79,155,19,75,147,145,143,35,69,17,67,33,65,255,251,247,243,239,59,29,229,113,111,219,27,213,105,207,51,201,199,49,193,191,47,93,183,181,179,11,87,43,85,167,165,163,161,159,157,155,77,19,75,37,73,145,143,141,35,138,137,135,67,33,131,129,255,63,250,247,61,121,239,237,117,29,229,227,225,111,55,109,216,213,211,209,207,205,203,201,199,197,195,193,48,190,47,93,185,183,181,179,178,176,175,173,171,85,21,167,165,41,163,161,5,79,157,78,154,153,19,75,149,74,147,73,144,143,71,141,140,139,137,17,135,134,133,66,131,65,129,1],shg_table=[0,9,10,10,14,12,14,14,16,15,16,15,16,15,15,17,18,17,12,18,16,17,17,19,19,18,19,18,18,19,19,19,20,19,20,20,20,20,20,20,15,20,19,20,20,20,21,21,21,20,20,20,21,18,21,21,21,21,20,21,17,21,21,21,22,22,21,22,22,21,22,21,19,22,22,19,20,22,22,21,21,21,22,22,22,18,22,22,21,22,22,23,22,20,23,22,22,23,23,21,19,21,21,21,23,23,23,22,23,23,21,23,22,23,18,22,23,20,22,23,23,23,21,22,20,22,21,22,24,24,24,24,24,22,21,24,23,23,24,21,24,23,24,22,24,24,22,24,24,22,23,24,24,24,20,23,22,23,24,24,24,24,24,24,24,23,21,23,22,23,24,24,24,22,24,24,24,23,22,24,24,25,23,25,25,23,24,25,25,24,22,25,25,25,24,23,24,25,25,25,25,25,25,25,25,25,25,25,25,23,25,23,24,25,25,25,25,25,25,25,25,25,24,22,25,25,23,25,25,20,24,25,24,25,25,22,24,25,24,25,24,25,25,24,25,25,25,25,22,25,25,25,24,25,24,25,18];Resize.prototype.doResize=function(a,b){a=Math.floor(a);var c=parseInt(b*this.HEIGHT_PROPORTION),d=this.sumWidth(c),e=Math.ceil(d/a);return this.resizeUsingLinearPartitions(e,a)},Resize.prototype.sumWidth=function(a){var b,c=0;for(var d in this.pictures)b=this.pictures[d],c+=b.ratio*a;return c},Resize.prototype.resizeToSameHeight=function(a){var b;for(var c in this.pictures)b=this.pictures[c],b.newWidth=parseInt(a*b.ratio),b.newHeight=a;return this.pictures},Resize.prototype.resizeUsingLinearPartitions=function(a,b){var c,d,e,f=[];for(d in this.pictures)c=this.pictures[d],f.push(parseInt(100*c.ratio));var g=linearPartition(f,a),h=0,i=[];for(d in g){partition=g[d];var j=[];for(e in partition)j.push(this.pictures[h]),h++;var k=0;for(e in j)c=j[e],k+=c.ratio;var l=b/k,m=0;for(e in j){c=j[e];var n={};n.newWidth=parseInt(l*c.ratio),m+=n.newWidth,n.newHeight=parseInt(l),i.push(n)}}return i};